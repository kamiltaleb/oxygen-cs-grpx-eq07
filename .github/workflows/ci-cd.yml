name: CI/CD Pipeline

on:
  push:
    branches:
      - main
      - develop

env:
  MYSQL_HOST: 127.0.0.1
  MYSQL_DATABASE: log680
  MYSQL_USER: root
  MYSQL_ROOT_PASSWORD: root

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Set up Python
        uses: actions/setup-python@v2
        with:
          python-version: 3.9

      - name: Start MySQL service
        run: sudo systemctl start mysql.service

      - name: Install MySQL client
        run: sudo apt-get install mysql-client -y

      - name: Set up Database
        run: |
          mysql -h $MYSQL_HOST -u $MYSQL_USER -p$MYSQL_ROOT_PASSWORD -e "CREATE DATABASE IF NOT EXISTS $MYSQL_DATABASE;"
          mysql -h $MYSQL_HOST -u $MYSQL_USER -p$MYSQL_ROOT_PASSWORD $MYSQL_DATABASE -e "CREATE TABLE IF NOT EXISTS hvac_data (timestamp datetime not null, event longtext not null);"

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Run unit tests
        env:
          HOST: http://34.95.34.5
          TICKETS: 1
          TOKEN: fMupq1cdfE
          T_MAX: 25
          T_MIN: 17
        run: pytest
